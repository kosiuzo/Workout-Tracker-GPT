openapi: 3.1.0
info:
  title: Workout Tracker GPT API v2
  version: 2.0.0
  description: |
    Comprehensive workout tracking API v2 optimized for ChatGPT integration.
    Built on flat-table architecture for improved performance and simplicity.

    Features:
    - Create and manage workout templates with JSON structure
    - Log workout sessions with detailed set-by-set tracking
    - Track progress over time for exercises and workouts
    - Automatic history calculations and aggregations
    - Support for progressive overload and superset tracking

    This API uses Supabase PostgREST with specialized RPC functions for complex workflows.
    Authentication: JWT tokens via Authorization header (handled by Supabase).

servers:
  - url: https://xcydnrhqidokisawwhzc.supabase.co/rest/v1
    description: Production Supabase instance

security:
  - apiKeyAuth: []

paths:
  # =====================================================
  # WORKOUT MANAGEMENT (Flat-Table Optimized)
  # =====================================================

  /workouts_flat:
    get:
      operationId: listWorkoutsFlat
      summary: List all workouts from flat table
      description: Returns all saved workout templates with exercises organized by day.
      tags:
        - Workouts
      parameters:
        - name: workout_name
          in: query
          description: Filter by workout name
          schema:
            type: string
        - name: workout_is_active
          in: query
          description: Filter by active status (true/false)
          schema:
            type: boolean
      responses:
        '200':
          description: List of workouts retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkoutFlat'

  /rpc/create_workout_from_json:
    post:
      operationId: createWorkoutFromJson
      summary: Create workout from JSON structure
      description: Creates a complete workout from JSON with days and exercises. Single call to create entire workout.
      tags:
        - Workouts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkoutJsonRequest'
      responses:
        '200':
          description: Workout created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  workout_name:
                    type: string
                  workout_description:
                    type: string
                  is_active:
                    type: boolean
                  rows_inserted:
                    type: integer
                  message:
                    type: string

  /rpc/set_active_workout:
    post:
      operationId: setActiveWorkout
      summary: Set a workout as active (text-based)
      description: Activates a workout by name and deactivates all others. Only one workout can be active at a time.
      tags:
        - Workouts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - workout_name_param
              properties:
                workout_name_param:
                  type: string
                  description: Name of the workout to activate
                  example: "Push/Pull/Legs"
      responses:
        '200':
          description: Workout activated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  workout_name:
                    type: string

  /rpc/get_todays_exercises_flat:
    post:
      operationId: getTodaysExercisesFlat
      summary: Get today's exercises (RECOMMENDED)
      description: Returns only today's exercises for the active workout using Eastern Time. Single-call solution.
      tags:
        - Workouts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties: {}
      responses:
        '200':
          description: Today's exercises
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  workout_name:
                    type: string
                  day:
                    type: string
                    enum:
                      - monday
                      - tuesday
                      - wednesday
                      - thursday
                      - friday
                      - saturday
                      - sunday
                  exercises:
                    type: array
                    items:
                      $ref: '#/components/schemas/ExerciseFlat'
                  message:
                    type: string

  /rpc/get_exercises_for_day_flat:
    post:
      operationId: getExercisesForDayFlat
      summary: Get exercises for a specific day
      description: Returns exercises for a specific day from active or specified workout.
      tags:
        - Workouts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - day_name_param
              properties:
                day_name_param:
                  type: string
                  description: Day name (e.g., "monday", "tuesday")
                  example: "monday"
                workout_name_param:
                  type: string
                  description: Optional workout name (uses active if not provided)
      responses:
        '200':
          description: Exercises for the day
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ExerciseFlat'

  /rpc/get_todays_workout:
    post:
      operationId: getTodaysWorkout
      summary: Get today's complete workout
      description: Returns today's workout template from active workout.
      tags:
        - Workouts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties: {}
      responses:
        '200':
          description: Today's workout
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  workout_name:
                    type: string
                  day:
                    type: string
                  exercises:
                    type: array
                    items:
                      $ref: '#/components/schemas/ExerciseFlat'

  # =====================================================
  # SESSION MANAGEMENT (Flat-Table Optimized)
  # =====================================================

  /sessions_flat:
    get:
      operationId: listSessionsFlat
      summary: List workout sessions
      description: Returns all workout sessions from flat table.
      tags:
        - Sessions
      parameters:
        - name: workout_name
          in: query
          description: Filter by workout name
          schema:
            type: string
        - name: session_date
          in: query
          description: Filter by session date
          schema:
            type: string
            format: date
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SessionFlat'

  /rpc/log_set:
    post:
      operationId: logSet
      summary: Log a single set
      description: Logs a single set for a workout session.
      tags:
        - Sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - workout_name_param
                - session_date_param
                - exercise_name_param
                - set_number_param
                - reps_param
                - weight_param
              properties:
                workout_name_param:
                  type: string
                  description: Workout name
                session_date_param:
                  type: string
                  format: date
                  description: Session date
                exercise_name_param:
                  type: string
                  description: Exercise name
                set_number_param:
                  type: integer
                  description: Set number (1, 2, 3...)
                reps_param:
                  type: integer
                  description: Reps completed
                weight_param:
                  type: number
                  description: Weight used
                notes_param:
                  type: string
                  description: Optional notes
      responses:
        '200':
          description: Set logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /rpc/log_multiple_sets:
    post:
      operationId: logMultipleSets
      summary: Log multiple sets at once
      description: Logs multiple sets for a workout session in a single call.
      tags:
        - Sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - workout_name_param
                - session_date_param
                - sets_data_param
              properties:
                workout_name_param:
                  type: string
                  description: Workout name
                session_date_param:
                  type: string
                  format: date
                  description: Session date
                sets_data_param:
                  type: array
                  description: Array of sets to log
                  items:
                    type: object
                    properties:
                      exercise_name:
                        type: string
                      set_number:
                        type: integer
                      reps:
                        type: integer
                      weight:
                        type: number
                      notes:
                        type: string
                notes_param:
                  type: string
                  description: Optional session notes
      responses:
        '200':
          description: Sets logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  rows_inserted:
                    type: integer
                  message:
                    type: string

  /rpc/update_set:
    post:
      operationId: updateSet
      summary: Update a set in session
      description: Updates reps or weight for a specific set in a session.
      tags:
        - Sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - workout_name_param
                - session_date_param
                - exercise_name_param
                - set_number_param
              properties:
                workout_name_param:
                  type: string
                session_date_param:
                  type: string
                  format: date
                exercise_name_param:
                  type: string
                set_number_param:
                  type: integer
                reps_param:
                  type: integer
                  description: New reps (optional)
                weight_param:
                  type: number
                  description: New weight (optional)
      responses:
        '200':
          description: Set updated successfully

  /rpc/delete_set:
    post:
      operationId: deleteSet
      summary: Delete a set from session
      description: Removes a specific set from a workout session.
      tags:
        - Sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - workout_name_param
                - session_date_param
                - exercise_name_param
                - set_number_param
              properties:
                workout_name_param:
                  type: string
                session_date_param:
                  type: string
                  format: date
                exercise_name_param:
                  type: string
                set_number_param:
                  type: integer
      responses:
        '200':
          description: Set deleted successfully

  /rpc/get_session_sets_flat:
    post:
      operationId: getSessionSetsFlat
      summary: Get all sets from a session
      description: Returns all sets logged for a specific session.
      tags:
        - Sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - workout_name_param
                - session_date_param
              properties:
                workout_name_param:
                  type: string
                session_date_param:
                  type: string
                  format: date
      responses:
        '200':
          description: Session sets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SessionFlat'

  /rpc/get_todays_session:
    post:
      operationId: getTodaysSession
      summary: Get today's session with all sets
      description: Returns all sets logged for today's workout session.
      tags:
        - Sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties: {}
      responses:
        '200':
          description: Today's session
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SessionFlat'

  # =====================================================
  # PROGRESS TRACKING
  # =====================================================

  /rpc/get_exercise_progress:
    post:
      operationId: getExerciseProgress
      summary: Get exercise progress history
      description: Returns progress data for a specific exercise over time.
      tags:
        - Progress
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - exercise_name_param
              properties:
                exercise_name_param:
                  type: string
                  description: Name of the exercise
                  example: "Bench Press"
                days_back_param:
                  type: integer
                  description: Number of days to look back
                  default: 30
                workout_name_param:
                  type: string
                  description: Optional filter by workout
      responses:
        '200':
          description: Exercise progress data
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProgressData'

  /rpc/get_recent_progress:
    post:
      operationId: getRecentProgress
      summary: Get recent workout history
      description: Returns workout history for the last N days.
      tags:
        - Progress
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                days_back_param:
                  type: integer
                  description: Number of days to look back
                  default: 7
                workout_name_param:
                  type: string
                  description: Optional filter by workout
      responses:
        '200':
          description: Recent workout history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProgressData'

  /rpc/get_exercise_history_flat:
    post:
      operationId: getExerciseHistoryFlat
      summary: Get exercise history with stats
      description: Returns aggregated exercise statistics from flat tables.
      tags:
        - Progress
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - exercise_name_param
              properties:
                exercise_name_param:
                  type: string
                days_back_param:
                  type: integer
                  default: 30
                workout_name_param:
                  type: string
      responses:
        '200':
          description: Exercise history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProgressData'

  /rpc/get_workout_summary_flat:
    post:
      operationId: getWorkoutSummaryFlat
      summary: Get workout summary by exercise
      description: Returns summary of exercises performed in a session.
      tags:
        - Progress
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - workout_name_param
                - session_date_param
              properties:
                workout_name_param:
                  type: string
                session_date_param:
                  type: string
                  format: date
      responses:
        '200':
          description: Workout summary
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProgressData'

  # =====================================================
  # HISTORY AGGREGATION
  # =====================================================

  /rpc/calc_exercise_history:
    post:
      operationId: calcExerciseHistory
      summary: Calculate exercise history aggregates
      description: Aggregates session data into exercise_history for a specific date. Idempotent.
      tags:
        - History
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                date_override:
                  type: string
                  format: date
                  description: Specific date to calculate (defaults to today)
      responses:
        '200':
          description: Exercise history calculated successfully

  /rpc/calc_workout_history:
    post:
      operationId: calcWorkoutHistory
      summary: Calculate workout history aggregates
      description: Aggregates exercise_history into workout_history for a specific date.
      tags:
        - History
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                date_override:
                  type: string
                  format: date
                  description: Specific date to calculate (defaults to today)
      responses:
        '200':
          description: Workout history calculated successfully

  /rpc/calc_all_history:
    post:
      operationId: calcAllHistory
      summary: Calculate all history aggregates
      description: Runs both exercise and workout history calculations in a single transaction.
      tags:
        - History
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                date_override:
                  type: string
                  format: date
                  description: Specific date to calculate (defaults to today)
      responses:
        '200':
          description: All history calculated successfully

components:
  securitySchemes:
    apiKeyAuth:
      type: apiKey
      in: header
      name: apikey

  schemas:
    WorkoutFlat:
      type: object
      description: A workout template from the flat table architecture
      properties:
        workout_name:
          type: string
          description: Name of the workout
        workout_description:
          type: string
          description: Description of the workout
        workout_is_active:
          type: boolean
          description: Whether this workout is currently active
        day_name:
          type: string
          description: Day of the week (monday, tuesday, etc.)
        day_notes:
          type: string
          description: Notes for this day
        exercise_order:
          type: integer
          description: Exercise order within the day (0-indexed)
        exercise_name:
          type: string
          description: Name of the exercise
        sets:
          type: integer
          description: Number of sets
        reps:
          type: integer
          description: Reps per set
        weight:
          type: integer
          description: Weight in pounds or kg
        superset_group:
          type: string
          description: Optional superset grouping
        exercise_notes:
          type: string
          description: Optional exercise notes
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ExerciseFlat:
      type: object
      description: A single exercise from flat table
      properties:
        exercise_name:
          type: string
          example: "Bench Press"
        sets:
          type: integer
          example: 4
        reps:
          type: integer
          example: 6
        weight:
          type: integer
          example: 225
        superset_group:
          type: string
          example: "A"
        exercise_notes:
          type: string

    SessionFlat:
      type: object
      description: A workout session entry from flat table
      properties:
        workout_name:
          type: string
        session_date:
          type: string
          format: date
        exercise_name:
          type: string
        set_number:
          type: integer
        reps:
          type: integer
        weight:
          type: number
        notes:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateWorkoutJsonRequest:
      type: object
      description: Complete workout structure for create_workout_from_json
      required:
        - workout_name
        - days
      properties:
        workout_name:
          type: string
          description: Name of the workout
          example: "Push/Pull/Legs v1"
        workout_description:
          type: string
          description: Optional description
          example: "Classic PPL split"
        is_active:
          type: boolean
          description: Set as active workout (optional, defaults to false)
          default: false
        days:
          type: array
          description: Array of days with exercises
          items:
            type: object
            properties:
              day_name:
                type: string
                example: "monday"
              day_notes:
                type: string
              exercises:
                type: array
                items:
                  type: object
                  properties:
                    exercise_name:
                      type: string
                      example: "Bench Press"
                    sets:
                      type: integer
                      example: 4
                    reps:
                      type: integer
                      example: 6
                    weight:
                      type: number
                      example: 225
                    superset_group:
                      type: string
                    exercise_notes:
                      type: string

    ProgressData:
      type: object
      description: Progress tracking data
      properties:
        date:
          type: string
          format: date
        exercise_name:
          type: string
        total_volume:
          type: number
        max_weight:
          type: number
        avg_weight:
          type: number
        total_sets:
          type: integer
        total_reps:
          type: integer

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
        error:
          type: string
        message:
          type: string

tags:
  - name: Workouts
    description: Workout template management with flat-table optimization
  - name: Sessions
    description: Workout session logging and tracking
  - name: Progress
    description: Progress tracking and analytics
  - name: History
    description: Historical data aggregation and calculations
