openapi: 3.1.0
info:
  title: Workout Tracker GPT API
  version: 1.0.0
  description: |
    Comprehensive workout tracking API optimized for ChatGPT integration.
    Built on flat-table architecture for improved performance and simplicity.

    **Core Features:**
    - Create and manage workout templates (allows duplicate workout names)
    - Organize workouts by day with multiple exercises per day
    - Support for supersets and exercise ordering (includes float ordering like 1.5)
    - Log workout sessions with actual performed sets, reps, and weight
    - Track progress with exercise and workout history
    - Automatic history calculations and aggregations

    **API Architecture:**
    - Flat-table design for simplified queries and improved performance
    - RPC functions for complex workflows (create, update, retrieve workouts)
    - RESTful endpoints for direct table access (sessions, history)
    - Authentication: JWT tokens via Authorization header (Supabase managed)

servers:
  - url: https://xcydnrhqidokisawwhzc.supabase.co/rest/v1
    description: Production Supabase instance

security:
  - apiKeyAuth: []

paths:
  # =====================================================
  # WORKOUT MANAGEMENT - RPC Functions
  # =====================================================

  /rpc/create_workout:
    post:
      operationId: createWorkout
      summary: Create a new workout
      description: Creates a new workout with name and description. Fails if the workout name already exists.
      tags:
        - Workouts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - p_workout_name
                - p_workout_description
              properties:
                p_workout_name:
                  type: string
                  description: Unique name for the workout
                  example: "Push/Pull/Legs v1"
                p_workout_description:
                  type: string
                  description: Description of the workout
                  example: "Classic PPL split focusing on progressive overload"
      responses:
        '200':
          description: Workout created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  workout_name:
                    type: string
                  workout_description:
                    type: string

  /rpc/add_workout_day:
    post:
      operationId: addWorkoutDay
      summary: Add exercises for a specific day
      description: Appends exercises for a specific day to an existing workout. Call once per day to build multi-day workout while avoiding payload limits.
      tags:
        - Workouts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - p_workout_name
                - p_day_name
                - p_exercises
              properties:
                p_workout_name:
                  type: string
                  description: Name of the workout to append to
                  example: "Push/Pull/Legs v1"
                p_day_name:
                  $ref: '#/components/schemas/DayOfWeek'
                p_exercises:
                  type: array
                  description: Array of exercise objects for this day
                  items:
                    $ref: '#/components/schemas/ExerciseInput'
      responses:
        '200':
          description: Exercises added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  workout_name:
                    type: string
                  day_name:
                    type: string
                  exercises_added:
                    type: integer

  /rpc/set_active_workout:
    post:
      operationId: setActiveWorkout
      summary: Set a workout as active
      description: Sets the specified workout as the active workout. Automatically deactivates all other workouts. Only one can be active at a time.
      tags:
        - Workouts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - p_workout_name
              properties:
                p_workout_name:
                  type: string
                  description: Name of the workout to activate
                  example: "Push/Pull/Legs v1"
      responses:
        '200':
          description: Workout activated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  workout_name:
                    type: string
                  is_active:
                    type: boolean

  /rpc/get_active_workout:
    post:
      operationId: getActiveWorkout
      summary: Get the active workout
      description: Retrieves the currently active workout grouped by day, excluding internal placeholder rows.
      tags:
        - Workouts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties: {}
      responses:
        '200':
          description: Active workout retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  workout_name:
                    type: string
                  workout_description:
                    type: string
                  days:
                    type: object
                    description: Exercises grouped by day
                    additionalProperties:
                      type: array
                      items:
                        $ref: '#/components/schemas/Exercise'

  /rpc/log_current_workout:
    post:
      operationId: logCurrentWorkout
      summary: Log the active workout for a day
      description: Logs the active workout for a specified day into the sessions table. Copies sets, reps, and weight from the workout template.
      tags:
        - Sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                p_day_name:
                  $ref: '#/components/schemas/DayOfWeek'
                  description: "Day name in lowercase (optional, defaults to current day of week)"
                p_session_date:
                  type: string
                  format: date
                  description: "Session date (optional, defaults to today)"
      responses:
        '200':
          description: Workout logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  workout_name:
                    type: string
                  session_date:
                    type: string
                    format: date
                  day_name:
                    type: string
                  exercises_logged:
                    type: integer

  # =====================================================
  # WORKOUT LIST - Direct Table Access
  # =====================================================

  /workouts:
    get:
      operationId: listWorkouts
      summary: List all workouts
      description: Returns all saved workout templates with exercises organized by day.
      tags:
        - Workouts
      parameters:
        - name: workout_name
          in: query
          description: Filter by workout name
          schema:
            type: string
        - name: workout_is_active
          in: query
          description: Filter by active status
          schema:
            type: boolean
      responses:
        '200':
          description: List of workouts retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkoutRow'
    patch:
      operationId: updateWorkoutExercise
      summary: Update a specific exercise in a workout
      description: Updates a specific exercise within a workout template (sets, reps, weight, notes, etc).
      tags:
        - Workouts
      parameters:
        - name: workout_name
          in: query
          required: true
          description: Workout name
          schema:
            type: string
        - name: day_name
          in: query
          required: true
          description: Day of the week
          schema:
            $ref: '#/components/schemas/DayOfWeek'
        - name: exercise_order
          in: query
          required: true
          description: Exercise position in day
          schema:
            type: number
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                exercise_name:
                  type: string
                  description: Name of the exercise
                sets:
                  type: integer
                  description: Number of sets
                reps:
                  type: integer
                  description: Reps per set
                weight:
                  type: integer
                  description: Target weight
                superset_group:
                  type: string
                  nullable: true
                  description: Optional superset grouping
                exercise_notes:
                  type: string
                  description: Optional exercise notes
      responses:
        '200':
          description: Exercise updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  workout_name:
                    type: string
                  day_name:
                    type: string
                  exercise_order:
                    type: number

  # =====================================================
  # SESSION MANAGEMENT - Direct Table Access
  # =====================================================

  /sessions:
    get:
      operationId: listSessions
      summary: List workout sessions
      description: Returns all workout sessions from the sessions table.
      tags:
        - Sessions
      parameters:
        - name: workout_name
          in: query
          description: Filter by workout name
          schema:
            type: string
        - name: session_date
          in: query
          description: Filter by session date
          schema:
            type: string
            format: date
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Session'
  # =====================================================
  # PROGRESS TRACKING - Direct Table Access
  # =====================================================
  # Use GET /sessions for direct access to workout session data
  # Use GET /exercise_history for aggregated statistics
  # Use GET /workout_history for daily workout summaries

components:
  securitySchemes:
    apiKeyAuth:
      type: apiKey
      in: header
      name: apikey

  schemas:
    DayOfWeek:
      type: string
      enum:
        - monday
        - tuesday
        - wednesday
        - thursday
        - friday
        - saturday
        - sunday
      description: "Day of the week in lowercase"
      example: "monday"

    Exercise:
      type: object
      description: A single exercise
      properties:
        exercise_name:
          type: string
          example: "Bench Press"
        sets:
          type: integer
          example: 4
        reps:
          type: integer
          example: 6
        weight:
          type: integer
          example: 225
        exercise_order:
          type: number
          description: "Exercise position (allows float like 1.5)"
          example: 1
        superset_group:
          type: string
          example: "A"
        exercise_notes:
          type: string
          example: "Barbell, touch chest each rep"

    WorkoutRow:
      type: object
      description: A single row from the workouts table (flat structure with exercise data)
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier
        workout_name:
          type: string
          description: Name of the workout
        workout_description:
          type: string
          description: Description of the workout
        workout_is_active:
          type: boolean
          description: Whether this workout is currently active
        day_name:
          $ref: '#/components/schemas/DayOfWeek'
        day_notes:
          type: string
          description: Notes for this day
        exercise_order:
          type: number
          description: "Exercise position in day (allows float like 1.5)"
        exercise_name:
          type: string
          description: Name of the exercise
        sets:
          type: integer
          description: Number of sets
        reps:
          type: integer
          description: Reps per set
        weight:
          type: integer
          description: Target weight
        superset_group:
          type: string
          nullable: true
          description: Optional superset grouping
        exercise_notes:
          type: string
          description: Optional exercise notes
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ExerciseInput:
      type: object
      description: Exercise input for creating/updating workouts
      required:
        - exercise_name
        - sets
        - reps
        - weight
        - exercise_order
      properties:
        exercise_name:
          type: string
          example: "Bench Press"
        sets:
          type: integer
          example: 4
        reps:
          type: integer
          example: 8
        weight:
          type: integer
          example: 185
        exercise_order:
          type: number
          description: "Position in day (allows 1.5 between 1 and 2)"
          example: 1
        superset_group:
          type: string
          nullable: true
          example: null
        exercise_notes:
          type: string
          example: "Barbell, touch chest each rep"

    Session:
      type: object
      description: A workout session entry
      properties:
        id:
          type: string
          format: uuid
        workout_name:
          type: string
        session_date:
          type: string
          format: date
        session_notes:
          type: string
        exercise_name:
          type: string
        sets:
          type: integer
        reps:
          type: integer
        weight:
          type: number
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProgressData:
      type: object
      description: Progress tracking data for an exercise
      properties:
        date:
          type: string
          format: date
        exercise_name:
          type: string
        total_volume:
          type: number
        max_weight:
          type: number
        avg_weight:
          type: number
        total_sets:
          type: integer
        total_reps:
          type: integer

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
        error:
          type: string
        message:
          type: string

tags:
  - name: Workouts
    description: Workout template management - create, manage, and retrieve workouts
  - name: Sessions
    description: Workout session logging and tracking
  - name: Progress
    description: Progress tracking and analytics
